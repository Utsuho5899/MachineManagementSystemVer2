@model MachineManagementSystemVer2.ViewModels.RepairCaseCreateViewModel

@{
    ViewData["Title"] = "建立維修案件";

    var workHours = Enumerable.Range(9, 15);
    var nightHours = Enumerable.Range(0, 9);
    var allHoursInOrder = workHours.Concat(nightHours);
    var hourOptions = allHoursInOrder.Select(h => new SelectListItem { Value = h.ToString(), Text = h.ToString("00") });

    var minuteOptions = new List<SelectListItem>
    {
        new SelectListItem { Value = "0", Text = "00" },
        new SelectListItem { Value = "15", Text = "15" },
        new SelectListItem { Value = "30", Text = "30" },
        new SelectListItem { Value = "45", Text = "45" },
    };
}

<style>
    .form-container {
        font-size: 1.5rem;
    }

    .info-box {
        background-color: #e9ecef;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        font-weight: 600;
    }

    select.form-control {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        padding-right: 2.5rem;
    }
</style>

<div class="form-container">
    <div class="d-flex justify-content-between align-items-center">
        <h1>@ViewData["Title"]</h1>
        <div class="info-box">
            建單人員：@ViewBag.LoggedInEmployeeName
        </div>
    </div>
    <hr />

    <div class="row">
        <div class="col-md-10">
            <form asp-action="Create" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="All" class="text-danger"></div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label asp-for="CustomerId" class="form-label"></label>
                        <select id="customerSelect" asp-for="CustomerId" class="form-control" asp-items="Model.CustomerList">
                            <option value="">-- 請選擇客戶 --</option>
                        </select>
                        <span asp-validation-for="CustomerId" class="text-danger"></span>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label asp-for="PlantId" class="form-label"></label>
                        <select id="plantSelect" asp-for="PlantId" class="form-control" asp-items="Model.PlantList">
                            <option value="">-- 請先選擇客戶 --</option>
                        </select>
                        <span asp-validation-for="PlantId" class="text-danger"></span>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label asp-for="DeviceId" class="form-label"></label>
                        <select id="deviceSelect" asp-for="DeviceId" class="form-control" asp-items="Model.DeviceList">
                            <option value="">-- 請先選擇廠區 --</option>
                        </select>
                        <span asp-validation-for="DeviceId" class="text-danger"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label asp-for="OccurredDate" class="form-label"></label>
                        <div class="input-group">
                            <input asp-for="OccurredDate" class="form-control" type="date" style="flex: 3 1 0%;" />
                            <select asp-for="OccurredHour" class="form-control" asp-items="hourOptions" style="flex: 0.5 1 0%;"></select>
                            <select asp-for="OccurredMinute" class="form-control" asp-items="minuteOptions" style="flex: 0.5 1 0%;"></select>
                        </div>
                        <span asp-validation-for="OccurredDate" class="text-danger"></span>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label asp-for="StartDate" class="form-label"></label>
                        <div class="input-group">
                            <input asp-for="StartDate" class="form-control" type="date" style="flex: 3 1 0%;" />
                            <select asp-for="StartHour" class="form-control" asp-items="hourOptions" style="flex: 0.5 1 0%;">
                                <option value="">--</option>
                            </select>
                            <select asp-for="StartMinute" class="form-control" asp-items="minuteOptions" style="flex: 0.5 1 0%;">
                                <option value="">--</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label asp-for="EndDate" class="form-label"></label>
                        <div class="input-group">
                            <input asp-for="EndDate" class="form-control" type="date" style="flex: 3 1 0%;" />
                            <select asp-for="EndHour" class="form-control" asp-items="hourOptions" style="flex: 0.5 1 0%;">
                                <option value="">--</option>
                            </select>
                            <select asp-for="EndMinute" class="form-control" asp-items="minuteOptions" style="flex: 0.5 1 0%;">
                                <option value="">--</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label asp-for="Title" class="form-label"></label>
                        <input asp-for="Title" class="form-control" />
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>
                </div>

                <div class="mb-3">
                    <label asp-for="CustomerContact" class="form-label"></label>
                    <input asp-for="CustomerContact" class="form-control" />
                    <span asp-validation-for="CustomerContact" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Description" class="form-label"></label>
                    <textarea asp-for="Description" class="form-control" rows="5"></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Photos" class="form-label"></label>
                    <input asp-for="Photos" class="form-control" type="file" multiple accept="image/*" />
                    <div id="photoPreview" class="mt-2 d-flex flex-wrap"></div>
                </div>

                <div class="mb-3">
                    <label asp-for="CaseRemark" class="form-label"></label>
                    <textarea asp-for="CaseRemark" class="form-control" rows="3"></textarea>
                    <span asp-validation-for="CaseRemark" class="text-danger"></span>
                </div>

                <div class="d-flex justify-content-start mt-4">
                    <button type="submit" class="btn btn-primary">建立案件</button>
                    <a asp-action="Index" class="btn btn-secondary ms-2">返回列表</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // --- 三層連動式下拉選單 ---
            $('#customerSelect').on('change', function () {
                var customerId = $(this).val();
                var plantSelect = $('#plantSelect');
                var deviceSelect = $('#deviceSelect');
                plantSelect.empty().append('<option value="">-- 正在載入廠區... --</option>');
                deviceSelect.empty().append('<option value="">-- 請先選擇廠區 --</option>');
                if (!customerId) {
                    plantSelect.empty().append('<option value="">-- 請先選擇客戶 --</option>');
                    return;
                }
                $.getJSON('@Url.Action("GetPlantsByCustomer", "RepairCases")', { customerId: customerId }, function (plants) {
                    plantSelect.empty().append('<option value="">-- 請選擇廠區 --</option>');
                    $.each(plants, function (index, plant) {
                        plantSelect.append($('<option/>', { value: plant.plantId, text: plant.plantName }));
                    });
                });
            });

            $('#plantSelect').on('change', function () {
                var plantId = $(this).val();
                var deviceSelect = $('#deviceSelect');
                deviceSelect.empty().append('<option value="">-- 正在載入設備... --</option>');
                if (!plantId) {
                    deviceSelect.empty().append('<option value="">-- 請先選擇廠區 --</option>');
                    return;
                }
                $.getJSON('@Url.Action("GetDevicesByPlant", "RepairCases")', { plantId: plantId }, function (devices) {
                    deviceSelect.empty().append('<option value="">-- 請選擇設備 --</option>');
                    $.each(devices, function (index, device) {
                        deviceSelect.append($('<option/>', { value: device.deviceId, text: device.deviceModel }));
                    });
                });
            });

            // --- 圖片預覽功能 ---
            $('#Photos').on('change', function(event) {
                var previewContainer = $('#photoPreview');
                previewContainer.empty();
                var files = event.target.files;
                if (files) {
                    for (var i = 0; i < files.length; i++) {
                        var file = files[i];
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            var img = $('<img />', {
                                src: e.target.result,
                                // 【調整尺寸】將預覽圖縮小為 100x100
                                style: 'width: 100px; height: 100px; object-fit: cover; margin: 5px; border: 1px solid #ddd; border-radius: 4px;'
                             });
                            previewContainer.append(img);
                        }
                        reader.readAsDataURL(file);
                    }
                }
            });
        });
    </script>
}
